---
title: "R Notebook"
output: html_notebook
---
In order to help inform the planning for provision of cancer treatment services in NHS Borders, we would like to gain better understanding of the incidence of cancer in NHS Borders

```{r}
library(tidyverse)
library(ggplot2)
library(tsibble)
library(fable)
library(lubridate)
library(urca)
library(here)
```
```{r}
borders_cancer <- read_csv(here("clean_data/borders_cancer.csv"))
healthboard_cancer <- read_csv(here("clean_data/healthboard_cancer.csv"))
```
###most common cancer types 
```{r}
ten_cancers <- borders_cancer %>% 
  group_by(cancer_site) %>% 
  filter(cancer_site != "All cancer types") %>% 
  summarise(proportion = round((sum(incidences_all_ages) / 406406)*100),1) %>% #make reproducible
  arrange(desc(proportion)) %>% 
  head(10) %>% 
  mutate(cancer_site = recode(cancer_site, #grouping sub-types 
                              "Basal cell carcinoma of the skin" = "Skin",
                              "Non-melanoma skin cancer" = "Skin",
                              "Squamous cell carcinoma of the skin" = "Skin",
                              "Trachea, bronchus and lung" = "Lung",
                              "Colorectal cancer" = "Colorectal",
                              "Carcinoma in situ of the breast" = "Breast",
                              "Carcinoma in situ of the cervix uteri" = "Cervix"))

ten_cancers %>% 
  ggplot(aes(x = cancer_site, y = proportion))+
  geom_col()+
  labs(title = "Most frequent cancer sites in the Borders",
       x = "Cancer site",
       y = "Percentage of all observations")+
  theme(panel.background = element_blank())
```
```{r}
borders_cancer %>% 
  group_by(cancer_site) %>% 
  filter(cancer_site != "All cancer types") %>% 
  summarise(proportion = (sum(incidences_all_ages) / 406406)*100,
            total = (sum(incidences_all_ages))) %>%
  arrange(desc(proportion))
```


Shows the highest occurring cancer sites observed in the borders as proportions. Chose to display this as provisioning equipment will need to be tailored to the occurance of different cancer types. I chose to display this in proportional terms as it is more useful when deciding to allocate budget to provisions specific to cancer types i.e. 23% budget to breast specific

###distribution of cancer by age
```{r}
borders_cancer_age <- borders_cancer %>% 
  summarise(across(starts_with("incidences_age"), sum)) %>% 
  pivot_longer(cols = everything(), 
               names_to = "age_bracket",
               values_to = "incidences_of_cancer") %>%
  mutate(age_bracket = str_remove_all(age_bracket, "[a-z]{10}_[a-z]{3}"),
         age_bracket = str_replace_all(age_bracket, "to", "-"),
         age_bracket = str_replace_all(age_bracket, "_under", "-"),
         age_bracket = str_replace_all(age_bracket, "and_over", "+"))

borders_cancer_age <- borders_cancer_age %>% 
  mutate(age_bracket = factor(age_bracket, levels = unique(borders_cancer_age$age_bracket)))

borders_cancer_age %>% 
  ggplot(aes(x = age_bracket,
             y = incidences_of_cancer))+
  geom_col()+
  labs(title = "Age distribution of cancer in the Borders",
       x = "Age bracket",
       y = "Incidence of cancer")+
  theme(panel.background = element_blank())

```

###cancer trend over time
```{r}
borders_cancer_time <- borders_cancer %>% 
  mutate(year = make_date(year),
         year = year(year)) %>% 
  filter(sex == "All", cancer_site == "All cancer types") %>% 
  select(year, incidences_all_ages)

borders_cancer_time <- as_tsibble(borders_cancer_time, index = year)

borders_cancer_time %>% 
  autoplot(incidences_all_ages)+
  labs(title = "Incidence of cancer in the Borders",
       x = "Year",
       y = "Incidence of cancer")+
  theme(panel.background = element_blank())
```
#forecast
```{r}


fit <- borders_cancer_time %>% 
  model( #creating fitted model
    mean_model = MEAN(incidences_all_ages),
    arima = ARIMA(incidences_all_ages),
    arima000 = ARIMA(incidences_all_ages ~ pdq(0,0,0)) #non-seasonal fit
  )

forecast <- fit %>% 
  forecast(h = 3) #forecast 3 years in advance 

forecast %>% #plot forecasts
  autoplot(borders_cancer_time)
```
#finding most accurate model
```{r}
years <- borders_cancer_time %>% #recorded years
  distinct(year) %>% 
  arrange(desc(year))

train <- borders_cancer_time %>% 
  filter_index("1996" ~ "2017")#training on data up to 2017

fit_train <- train %>% 
  model(
    mean_model = MEAN(incidences_all_ages),
    arima = ARIMA(incidences_all_ages),
    arima000 = ARIMA(incidences_all_ages ~ pdq(0,0,0))#create fit
  )

forecast_test <- fit_train %>% 
  fabletools::forecast(h =3) #test forecast

forecast_test %>% 
  autoplot(train, level = NULL)+
  autolayer(filter_index(borders_cancer_time, "2017" ~ .), colour = "black")
#models of similar accuracy, so keep both
```

